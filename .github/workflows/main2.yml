name: CI
on:
    push:
      branches: [ "main" ]

env:
    VERSION: 1.0.26-1
    PATCH_NAME: libusb_enable_emulate

jobs:
  debian-x86_build:
    runs-on: ubuntu-latest
    container: debian
    strategy:
      matrix:
        include:
          - arch: amd64 
          - arch: i386 
          - arch: arm64 
            extra_dep: crossbuild-essential-arm64
          - arch: armhf
            extra_dep: crossbuild-essential-armhf

    env:
        CROSS: ${{ matrix.arch != 'amd64' || matrix.arch != 'i386' }}
        DEP: sudo devscripts debian-keyring pkg-config docbook docbook-dsssl libudev-dev doxygen debhelper build-essential tree
        FetchSource: dget http://deb.debian.org/debian/pool/main/libu/libusb-1.0/libusb-1.0_${VERSION}.dsc
        CONFIG_SITE: /etc/dpkg-cross/cross-config.amd64
          #DEB_BUILD_OPTIONS: nocheck

    steps:
      - name: Fetch Repository
        uses: actions/checkout@v3
          
      - name: Cache Primes
        id: cache-primes
        uses: actions/cache@v3

      - name: Add architecture for dpkg if needed
        run: ${{ env.CROSS }} && dpkg --add-architecture ${{ matrix.arch }}

      - name: Prepare for build
        run: apt update && apt install ${{ env.DEP }} ${{ matrix.extra_dep }} -y


      - name: Fetch application source
        run: apt build-dep -a${{matrix.arch}} libusb-1.0 || ${{ env.FetchSource }}

      - name: Apply patch
        run: |
          tree
          echo "-------------------------------------------"
          
          quilt --quiltrc=quiltrc-dpkg new test.patch
          echo "quilt new finished."
          cd libusb*/
          cat patch/* | patch -tR -p2
          echo "apply patch finished"
          quilt --quiltrc=quiltrc-dpkg add ./*
          echo "quilt add finished"
          quilt --quiltrc=quiltrc-dpkg refresh
          echo "quilt refresh finished"
          dpkg-source --commit
          echo "dpkg-source --commit finished"

      - name: Build
        run: |
                ${{ env.CROSS }} && set -- -a${{ matrix.arch}} -Pcross
                dpkg-buildpackage $@

      - name: Generate files list
        run: |
          tree > ../filelist-${{matrix.arch}}.tree

      - name: Releases Files 
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: libusb-1.0_${{env.VERSION}}-test-lastest
          files: |
            **/${{env.PATCH_NAME}}.patch
            **/filelist*.tree
            **/*.deb
            **/*.udeb
